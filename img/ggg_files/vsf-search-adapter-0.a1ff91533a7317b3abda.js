(window.webpackJsonp=window.webpackJsonp||[]).push([[217],{1136:function(e,r,t){"use strict";var s=t(122),n=t(54),o=t(171),i=t(55);var u=function(e,r){var t=-1,s=Object(i.a)(e)?Array(e.length):[];return Object(o.a)(e,(function(e,n,o){s[++t]=r(e,n,o)})),s},c=t(20);r.a=function(e,r){return(Object(c.a)(e)?s.a:u)(e,Object(n.a)(r,3))}},594:function(e,r,t){"use strict";t.r(r),t.d(r,"SearchAdapter",(function(){return l}));var s=t(0),n=t(1136),o=t(63),i=t.n(o),u=t(3),c=t(6),a=t(1),l=function(){function e(){this.entities=[],this.initBaseTypes()}return e.prototype.search=function(e){return Object(s.b)(this,void 0,void 0,(function(){var r,t,n,o,l,h,y=this;return Object(s.d)(this,(function(p){switch(p.label){case 0:if(r=!1,"gtm"===e.sort&&(e.sort="",r=!0),!this.entities[e.type])throw new Error("No entity type registered for "+e.type);return r?(t=a.storeViews[e.store],[3,5]):[3,1];case 1:return null!==e.store?[3,2]:(n=Object(c.b)(),[3,4]);case 2:return[4,Object(c.f)(e.store)];case 3:n=p.sent(),p.label=4;case 4:t=n,p.label=5;case 5:return o=Object(u.j)(t.elasticsearch.host),o+="/"+e.type+"/store/"+t.storeCode.replace("_","-"),e.searchQuery&&(e.searchQuery._appliedFilters.map((function(r){if(["visibility","status","is_active"].indexOf(r.attribute)<0){var t=Object.keys(r.value),s="category"===e.type&&"_id"===r.attribute?"id":r.attribute;o+="/"+s+"/",Array.isArray(r.value[t[0]])?o+=r.value[t[0]].join(",").replace("/","*slash*"):o+="string"==typeof r.value[t[0]]?r.value[t[0]].replace("/","*slash*"):r.value[t[0]]}})),e.searchQuery._availableFilters&&e.searchQuery._availableFilters.length>0&&(o+="/aggregation/true")),e.size&&(o+="/size/"+e.size),e.from&&(o+="/from/"+e.from),e.sort&&(l=e.sort.split(":"),h=l[1]?l[1]:"asc",o+="/sort-"+l[0]+"/"+h),[2,i()(o,{method:"GET",mode:"cors",headers:{Accept:"application/json","Content-Type":"application/json"},body:null}).then((function(e){return Object(s.b)(y,void 0,void 0,(function(){var r;return Object(s.d)(this,(function(t){switch(t.label){case 0:return[4,e.json()];case 1:return(r=t.sent()).url=o,[2,r]}}))}))})).catch((function(e){return console.log("FetchError in request to ES: "+e.toString()),[]}))]}}))}))},e.prototype.handleResult=function(e,r,t,s){if(void 0===t&&(t=0),void 0===s&&(s=50),null===e)throw new Error("Invalid ES result - null not exepcted");if(e.hasOwnProperty("hits"))return{items:Object(n.a)(e.hits.hits,(function(e){return Object.assign(e._source,{_score:e._score,slug:e._source.slug?e._source.slug:e._source.hasOwnProperty("url_key")&&a.products.useMagentoUrlKeys?e._source.url_key:e._source.hasOwnProperty("name")?Object(u.n)(e._source.name)+"-"+e._source.id:""})})),total:e.hits.total,start:t,perPage:s,aggregations:e.aggregations,suggestions:e.suggest};var o=(e&&e.code)>=400||202===(e&&e.code)?e:null;throw e.error||o?new Error(JSON.stringify(e.error||e)):new Error("Unknown error with elasticsearch result in resultProcessor for entity type '"+r+"'")},e.prototype.registerEntityType=function(e,r){var t=r.url,s=void 0===t?"":t,n=r.queryProcessor,o=r.resultProcessor;return this.entities[e]={queryProcessor:n,resultProcessor:o},""!==s&&(this.entities[e].url=s),this},e.prototype.initBaseTypes=function(){var e=this;this.registerEntityType("product",{queryProcessor:function(e){return e},resultProcessor:function(r,t,s){return e.handleResult(r,"product",t,s)}}),this.registerEntityType("attribute",{queryProcessor:function(e){return e},resultProcessor:function(r,t,s){return e.handleResult(r,"attribute",t,s)}}),this.registerEntityType("warranty",{queryProcessor:function(e){return e},resultProcessor:function(r,t,s){return e.handleResult(r,"warranty",t,s)}}),this.registerEntityType("specification",{queryProcessor:function(e){return e},resultProcessor:function(r,t,s){return e.handleResult(r,"specification",t,s)}}),this.registerEntityType("category",{queryProcessor:function(e){return e},resultProcessor:function(r,t,s){return e.handleResult(r,"category",t,s)}}),this.registerEntityType("taxrule",{queryProcessor:function(e){return e},resultProcessor:function(r,t,s){return e.handleResult(r,"taxrule",t,s)}}),this.registerEntityType("review",{queryProcessor:function(e){return e},resultProcessor:function(r,t,s){return e.handleResult(r,"review",t,s)}}),this.registerEntityType("cms_page",{queryProcessor:function(e){return e},resultProcessor:function(r,t,s){return e.handleResult(r,"cms_page",t,s)}}),this.registerEntityType("cms_block",{queryProcessor:function(e){return e},resultProcessor:function(r,t,s){return e.handleResult(r,"cms_block",t,s)}}),this.registerEntityType("cms_hierarchy",{queryProcessor:function(e){return e},resultProcessor:function(r,t,s){return e.handleResult(r,"cms_hierarchy",t,s)}}),this.registerEntityType("brand",{queryProcessor:function(e){return e},resultProcessor:function(r,t,s){return e.handleResult(r,"brand",t,s)}})},e}()},595:function(e,r,t){"use strict";t.r(r),t.d(r,"SearchAdapter",(function(){return w}));var s=t(0),n=t(1136),o=t(1);function i(){if(!o.elasticsearch.hasOwnProperty("searchScoring"))return!1;var e,r,t,s=[],n=o.elasticsearch.searchScoring.attributes;if(!Object.keys(n).length)return!1;for(var i=0,u=Object.keys(n);i<u.length;i++)for(var c=u[i],a=0,l=Object.keys(n[c].scoreValues);a<l.length;a++){var h=l[a],y={filter:{match:(e={},r=c,t=h,r in e?Object.defineProperty(e,r,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[r]=t,e)},weight:n[c].scoreValues[h].weight};s.push(y)}return!!s.length&&{functions:s,score_mode:o.score_mode?o.score_mode:"multiply",boost_mode:o.boost_mode?o.boost_mode:"multiply",max_boost:o.max_boost?o.max_boost:100,min_score:o.function_min_score?o.function_min_score:1}}function u(e){return function(e){var r=o.elasticsearch.hasOwnProperty("searchScoring")?o.elasticsearch.searchScoring:{},t=r.hasOwnProperty("minimum_should_match")?r.minimum_should_match:"75%";"GET"===o.elasticsearch.queryMethod&&(t=encodeURIComponent(t));var s={query:e,operator:r.operator?r.operator:"or",fuzziness:r.fuzziness?r.fuzziness:"2",cutoff_frequency:r.cutoff_frequency?r.cutoff_frequency:"0.01",max_expansions:r.max_expansions?r.max_expansions:"3",prefix_length:r.prefix_length?r.prefix_length:"1",minimum_should_match:t,tie_breaker:r.tie_breaker?r.tie_breaker:"1"};return r.hasOwnProperty("analyzer")&&(s.analyzer=r.analyzer),s}(e)}function c(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",r=[];return o.elasticsearch.hasOwnProperty("searchableAttributes")&&o.elasticsearch.searchableAttributes[e]&&(r=o.elasticsearch.searchableAttributes[e]),r.hasOwnProperty("boost")?r.boost:1}function a(e){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"products",t=[];return o.hasOwnProperty(r)&&o[r].hasOwnProperty("filterFieldMapping")&&(t=o[r].filterFieldMapping),t.hasOwnProperty(e)?t[e]:e}var l=t(28);function h(e,r,t,s,n,o,i){try{var u=e[o](i),c=u.value}catch(e){return void t(e)}u.done?r(c):Promise.resolve(c).then(s,n)}function y(e){return function(){var r=this,t=arguments;return new Promise((function(s,n){var o=e.apply(r,t);function i(e){h(o,s,n,i,u,"next",e)}function u(e){h(o,s,n,i,u,"throw",e)}i(void 0)}))}}function p(e){return f.apply(this,arguments)}function f(){return(f=y(regeneratorRuntime.mark((function e(r){var s,n,h,y,p,f,d,g,b,_,v,m,P,w,O,E,q,j;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,t.e(41).then(t.t.bind(null,2031,7));case 2:if(s=e.sent,"_options",n=r.getSearchText(),h=["gt","lt","gte","lte","moreq","from","to"],y=s.default(),(p=Object(l.a)(r.getAppliedFilters())).length>0&&(f=!1,p.forEach((function(e){"default"===e.scope?Object.keys(e.value).every((function(e){return h.includes(e)}))?y=y.filter("range",e.attribute,e.value):(e.value=e.value[Object.keys(e.value)[0]],Array.isArray(e.value)||(e.value=[e.value]),y=y.filter("terms",a(e.attribute),e.value)):"catalog"===e.scope&&(f=!0)})),d=function(e){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";return p.forEach((function(t){var s=Object.keys(t.value);if("catalog"===t.scope&&s.length)if(s.filter((function(e){return-1!==h.indexOf(e)})).length){var n=t.attribute;"price"===n&&(n=o.products.priceFilterKey),e=e.andFilter("range",n,t.value)}else{var i=t.value[Object.keys(t.value)[0]];Array.isArray(i)||(i=[i]),e=""===r?e.andFilter("terms",a(t.attribute),i):e.andFilter("terms",t.attribute+r,i)}})),e},f&&(y=y.filterMinimumShouldMatch(1).orFilter("bool",d).orFilter("bool",(function(e){return d(e,"_options").filter("match","type_id","configurable")})))),!((g=r.getAvailableFilters()).length>0)){e.next=30;break}for(b=!0,_=!1,v=void 0,e.prev=14,m=g[Symbol.iterator]();!(b=(P=m.next()).done);b=!0)"catalog"===(w=P.value).scope&&("price"!==w.field?(O={size:o.products.filterAggregationSize[w.field]||o.products.filterAggregationSize.default},y=(y=y.aggregation("terms",a(w.field),O)).aggregation("terms",w.field+"_options",O)):(y=y.aggregation("terms",w.field)).aggregation("range","price",o.products.priceFilters));e.next=22;break;case 18:e.prev=18,e.t0=e.catch(14),_=!0,v=e.t0;case 22:e.prev=22,e.prev=23,b||null==m.return||m.return();case 25:if(e.prev=25,!_){e.next=28;break}throw v;case 28:return e.finish(25);case 29:return e.finish(22);case 30:return E=function(e){for(var r=o.elasticsearch.hasOwnProperty("searchableAttributes")?o.elasticsearch.searchableAttributes:{name:{boost:1}},t=[],s=0,i=Object.keys(r);s<i.length;s++){var a=i[s];t.push(a+"^"+c(a))}return e.orQuery("multi_match","fields",t,u(n)).orQuery("bool",(function(e){return e.orQuery("terms","configurable_children.sku",n.split("-")).orQuery("match_phrase","sku",{query:n,boost:1}).orQuery("match_phrase","configurable_children.sku",{query:n,boost:1})}))},""!==n&&(q=i(),y=q?y.query("function_score",q,E):y.query("bool",E)),j=y.build(),r.suggest&&(j.suggest=r.suggest),e.abrupt("return",j);case 35:case"end":return e.stop()}}),e,null,[[14,18,22,30],[23,,25,29]])})))).apply(this,arguments)}var d=t(63),g=t.n(d),b=t(3),_=t(173),v=t.n(_),m=t(6),P=t(14),w=function(){function e(){this.entities=[],this.initBaseTypes()}return e.prototype.search=function(e){return Object(s.b)(this,void 0,void 0,(function(){var r,t,n,i,u,c;return Object(s.d)(this,(function(s){switch(s.label){case 0:if(!this.entities[e.type])throw new Error("No entity type registered for "+e.type);return r={},e.searchQuery instanceof P.a?[4,p(e.searchQuery)]:[3,2];case 1:return r=s.sent(),""!==e.searchQuery.getSearchText()&&(r.min_score=o.elasticsearch.min_score),[3,3];case 2:r=e.searchQuery,s.label=3;case 3:return e.hasOwnProperty("groupId")&&null!==e.groupId&&(r.groupId=e.groupId),e.hasOwnProperty("groupToken")&&null!==e.groupToken&&(r.groupToken=e.groupToken),null!==e.store?[3,4]:(n=Object(m.b)(),[3,6]);case 4:return[4,Object(m.f)(e.store)];case 5:n=s.sent(),s.label=6;case 6:if(t=n,e.index=t.elasticsearch.index,i=Object(b.j)(t.elasticsearch.host),this.entities[e.type].url&&(i=this.entities[e.type].url),u={size:e.size,from:e.from,sort:e.sort},e._sourceExclude&&(u._source_exclude=e._sourceExclude.join(",")),e._sourceInclude&&(u._source_include=e._sourceInclude.join(",")),e.q&&(u.q=e.q),!e.index||!e.type)throw new Error("Query.index and Query.type are required arguments for executing ElasticSearch query");return c=JSON.stringify(r).replace("slug","slug.keyword").replace("url_path","url_path.keyword").replace("sku","sku.keyword"),u.sort=u.sort.replace("updated_at","updated_at.keyword").replace("name","name.keyword"),"GET"===o.elasticsearch.queryMethod&&(u.request=c),i=(i=i+"/"+encodeURIComponent(e.index)+"/"+encodeURIComponent(e.type)+"/_search")+"?"+v.a.stringify(u),[2,g()(i,{method:o.elasticsearch.queryMethod,mode:"cors",headers:{Accept:"application/json","Content-Type":"application/json"},body:"POST"===o.elasticsearch.queryMethod?c:null}).then((function(e){return e.json()})).catch((function(e){throw new Error("FetchError in request to ES: "+e.toString())}))]}}))}))},e.prototype.handleResult=function(e,r,t,s){if(void 0===t&&(t=0),void 0===s&&(s=50),null===e)throw new Error("Invalid ES result - null not exepcted");if(e.hasOwnProperty("hits"))return{items:Object(n.a)(e.hits.hits,(function(e){return Object.assign(e._source,{_score:e._score,slug:e._source.slug?e._source.slug:e._source.hasOwnProperty("url_key")&&o.products.useMagentoUrlKeys?e._source.url_key:e._source.hasOwnProperty("name")?Object(b.n)(e._source.name)+"-"+e._source.id:""})})),total:e.hits.total,start:t,perPage:s,aggregations:e.aggregations,suggestions:e.suggest};var i=(e&&e.code)>=400?e:null;throw e.error||i?new Error(JSON.stringify(e.error||e)):new Error("Unknown error with elasticsearch result in resultProcessor for entity type '"+r+"'")},e.prototype.registerEntityType=function(e,r){var t=r.url,s=void 0===t?"":t,n=r.queryProcessor,o=r.resultProcessor;return this.entities[e]={queryProcessor:n,resultProcessor:o},""!==s&&(this.entities[e].url=s),this},e.prototype.initBaseTypes=function(){var e=this;this.registerEntityType("product",{queryProcessor:function(e){return e},resultProcessor:function(r,t,s){return e.handleResult(r,"product",t,s)}}),this.registerEntityType("attribute",{queryProcessor:function(e){return e},resultProcessor:function(r,t,s){return e.handleResult(r,"attribute",t,s)}}),this.registerEntityType("category",{queryProcessor:function(e){return e},resultProcessor:function(r,t,s){return e.handleResult(r,"category",t,s)}}),this.registerEntityType("taxrule",{queryProcessor:function(e){return e},resultProcessor:function(r,t,s){return e.handleResult(r,"taxrule",t,s)}}),this.registerEntityType("review",{queryProcessor:function(e){return e},resultProcessor:function(r,t,s){return e.handleResult(r,"review",t,s)}}),this.registerEntityType("cms_page",{queryProcessor:function(e){return e},resultProcessor:function(r,t,s){return e.handleResult(r,"cms_page",t,s)}}),this.registerEntityType("cms_block",{queryProcessor:function(e){return e},resultProcessor:function(r,t,s){return e.handleResult(r,"cms_block",t,s)}}),this.registerEntityType("cms_hierarchy",{queryProcessor:function(e){return e},resultProcessor:function(r,t,s){return e.handleResult(r,"cms_hierarchy",t,s)}}),this.registerEntityType("brand",{queryProcessor:function(e){return e},resultProcessor:function(r,t,s){return e.handleResult(r,"brand",t,s)}})},e}()}}]);
//# sourceMappingURL=vsf-search-adapter-0.a1ff91533a7317b3abda.js.map